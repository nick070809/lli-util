package org.kx.util.base.str;

import com.alibaba.fastjson.JSONArray;
import com.alibaba.fastjson.JSONObject;
import org.junit.Test;
import org.kx.util.PriorityLog;
import org.kx.util.biz.IntegrateUtilEnhance;
import org.kx.util.biz.SettleRequestInfo;
import org.kx.util.biz.SqlLevel;

import java.io.IOException;
import java.math.BigDecimal;
import java.util.*;

/**
 * Description ：
 * Created by  xianguang.skx
 * Since 2020/11/12
 */

public class CompareUtil {

    public static String compareSettleRequestInfo(List<SettleRequestInfo> s1, List<SettleRequestInfo> s2) throws IOException {
        //1、比较 operType
        PriorityLog priorityLog = new PriorityLog();
        for (SettleRequestInfo Ds1 : s1) {
            boolean Ds2Has = false;
            for (SettleRequestInfo Ds2 : s2) {
                if (Ds1.getOperType().equals(Ds2.getOperType())) {
                    Ds2Has = true;
                    compareSameOperType(Ds1, Ds2, priorityLog);
                }
            }
            if (!Ds2Has) {
                priorityLog.putInfo(Ds1.getOperType(), SqlLevel.Thrid, Ds1.getOperType() + " missing in Ds2");
            }
        }

        for (SettleRequestInfo Ds2 : s2) {
            boolean Ds1Has = false;
            for (SettleRequestInfo Ds1 : s1) {
                if (Ds1.getOperType().equals(Ds2.getOperType())) {
                    Ds1Has = true;
                }
            }
            if (!Ds1Has) {
                priorityLog.putInfo(Ds2.getOperType(), SqlLevel.Thrid, Ds2.getOperType() + " missing in Ds1");
            }
        }

        IntegrateUtilEnhance integrateUtilEnhance = new IntegrateUtilEnhance();
        integrateUtilEnhance.putLine(priorityLog.getLogs());

        return integrateUtilEnhance.getContent();
    }

    private static void compareSameOperType(SettleRequestInfo S1, SettleRequestInfo S2, PriorityLog PriorityLog) {
        JSONObject j1 = S1.getDetailParams();
        JSONObject j2 = S2.getDetailParams();

        for (Map.Entry<String, Object> entry : S1.getDetailParams().entrySet()) {

            String J1Key = entry.getKey();
            Object J1Value = entry.getValue();

            Object J2Value = j2.get(J1Key);
            if (J2Value == null) {
                PriorityLog.putInfo(S1.getOperType(), SqlLevel.Second, S1.getOperType() + "." + J1Key + " missing in Ds2." + S1.getOperType());
            } else if (!J1Value.equals(J2Value)) {
                if (J1Key.endsWith("amount")) {
                    BigDecimal amount1 = new BigDecimal((String) J1Value);
                    BigDecimal amount2 = new BigDecimal((String) J2Value);
                    if (amount1.compareTo(BigDecimal.ONE) < 0) {
                        amount1 = amount1.multiply(new BigDecimal(100));
                    }
                    if (amount2.compareTo(BigDecimal.ONE) < 0) {
                        amount2 = amount2.multiply(new BigDecimal(100));
                    }

                    if (amount1.compareTo(amount2) != 0) {
                        PriorityLog.putInfo(S1.getOperType(), SqlLevel.Second, S1.getOperType() + "." + J1Key + "(" + J1Value + ")" + " different from Ds2." + S1.getOperType() + "(" + J2Value + ")");
                    }
                } else {
                    PriorityLog.putInfo(S1.getOperType(), SqlLevel.Second, S1.getOperType() + "." + J1Key + "(" + J1Value + ")" + " different from Ds2." + S1.getOperType() + "(" + J2Value + ")");
                }
            }
        }
        for (Map.Entry<String, Object> entry : S2.getDetailParams().entrySet()) {
            String J2Key = entry.getKey();
            Object J1Value = j1.get(J2Key);
            if (J1Value == null) {
                PriorityLog.putInfo(S2.getOperType(), SqlLevel.Second, S2.getOperType() + "." + J2Key + " missing in Ds1." + S2.getOperType());

            }
        }
    }


    public static List<SettleRequestInfo> parseClause(JSONArray jsonArray, String[] keys) {
        List<SettleRequestInfo> list = new ArrayList<>();
        for (Object object : jsonArray) {
            JSONObject jsonObject = (JSONObject) object;
            StringBuilder key_ = new StringBuilder(jsonObject.getString(keys[0]));
            for (int i = 1; i < keys.length; i++) {
                key_.append("_").append(jsonObject.getString(keys[i]));
            }
            list.add(new SettleRequestInfo(key_.toString(), jsonObject));
        }
        return list;
    }


    private String compareStr(String str1, String str2) {
        Map<String, Integer> new_ = parse2map(str1);
        Map<String, Integer> old_ = parse2map(str2);

        return getDiffContent(new_, old_);
    }


    private Map<String, Integer> parse2map(String str) {
        Map<String, Integer> st = new HashMap<>();
        String[] words = str.split(",");
        Arrays.asList(words).stream().forEach(e -> {
            st.put(e, 1);
        });
        return st;
    }


    public static String getDiffContent(Map<String, Integer> map1, Map<String, Integer> map2) {


        StringBuilder b = new StringBuilder();
        StringBuilder a = new StringBuilder("result : \n");
        StringBuilder c = new StringBuilder();

        for (Map.Entry<String, Integer> entry : map1.entrySet()) {

            String key_ = entry.getKey();
            Integer oldVersion = map2.get(key_);
            if (oldVersion == null) {
                b.append("新增    " + key_).append("\n");
            }
        }
        for (Map.Entry<String, Integer> entry : map2.entrySet()) {
            String key_ = entry.getKey();
            Integer newVersion = map1.get(key_);
            if (newVersion == null) {
                c.append("减少   " + key_).append("\n");
            }
        }
        a.append(b).append(c);
        return a.toString();

    }


    @Test
    public  void testCompare() {

        String str1 = "JSTC_505747296537988623_0,JSTC_1099098403344779862_249,JSTC_102252259872271688_5,JSTC_155601776674271688_40,JSTC_897825346378411424_0,JSTC_1170182691976388110_0,JSTC_2972209687261688_4,JSTC_281840614732383794_3,JSTC_1251562488701694104_153,JSTC_1170182691976388110_15,JSTC_940848320263411424_0,JSTC_185616572035271688_18,JSTC_1055032000342411424_32,JSTC_61485602350271688_1,JSTC_620444161089394524_0,JSTC_104887115489271688_11,JSTC_1164452675386076953_47,JSTC_1251562488701694104_0,JSTC_76374607080271688_12,JSTC_898534304156411424_0,JSTC_885165314491411424_26,JSTC_940725089949411424_0,JSTC_61485602350271688_7,JSTC_94724793010271688_1,JSTC_940848320263411424_2,JSTC_59896575802271688_0,JSTC_61624452037010266_2,JSTC_73299687440797409_35,JSTC_59896575800271688_0,JSTC_1515263292745832058_0,JSTC_129916789165271688_28,JSTC_1055032000342411424_19,JSTC_506738019565279672_2,JSTC_931856419082411424_0,JSTC_2972209687281688_3,JSTC_2972209687261688_3,JSTC_152318626207364029_0,JSTC_885165314491411424_14,JSTC_905237538928411424_0,JSTC_97409091009271688_5,JSTC_1629815294272411424_0,JSTC_931826115070411424_8,JSTC_931758082072411424_0,JSTC_1055032000342411424_36,JSTC_931826115070411424_10,JSTC_885165314491411424_11,JSTC_1506353652128411785_0,JSTC_940248448231411424_0,JSTC_61485602350271688_10,JSTC_1159903328131405915_0,JSTC_885165314491411424_20,JSTC_1164571842003405915_0,JSTC_1185182432375668409_18,JSTC_572301924472163594_11,JSTC_506083105448475110_0,JSTC_1506353652128411785_21,JSTC_1630092025683411424_0,JSTC_329000194034843071_7,JSTC_71657583756676773_13,JSTC_931576322063411424_0,JSTC_885165314491411424_19,JSTC_1251440235884694104_153,JSTC_506117538000638667_4,JSTC_1159903328088411424_0,JSTC_885165314491411424_13,JSTC_611780780885388110_16,JSTC_1159903328133405915_0,JSTC_61485602350271688_3,JSTC_931747457904411424_0,JSTC_97409091009271688_6,JSTC_659821568948393686_194,JSTC_888302976757411424_5,JSTC_129916789165271688_104,JSTC_935614594771411424_0,JSTC_1163613984690076953_39,JSTC_1251440235884694104_155,JSTC_885165314491411424_17,JSTC_94724793010271688_3,JSTC_59955428940271688_2,JSTC_1630749891977411424_0,JSTC_931826115070411424_6,JSTC_940725089161411424_0,JSTC_924587523578411424_0,JSTC_185616572035271688_15,JSTC_1055032000342411424_12,JSTC_76374607080271688_14,JSTC_73299687440797409_32,JSTC_155601776674271688_0,JSTC_102252259872271688_3,JSTC_59955428940271688_0,JSTC_1352509992084382879_0,JSTC_1329690888772102543_0,JSTC_885165314491411424_27,JSTC_931826115070411424_4,JSTC_1159903328124405915_0,JSTC_1161995138702405915_0,JSTC_931826115070411424_2,JSTC_2972209687261688_6,JSTC_61485602350271688_0,JSTC_1513978201348547021_27,JSTC_3200616100401688_4,JSTC_155601776674271688_41,JSTC_682441120923495679_2,JSTC_96737909760271688_0,JSTC_930397056593411424_2,JSTC_129965874639271688_1,JSTC_1157043299930985949_71,JSTC_146115267166939567_2,JSTC_61485602350271688_2,JSTC_2972209687281688_1,JSTC_1055032000342411424_22,JSTC_888302976757411424_1,JSTC_1055032000342411424_4,JSTC_1055032000342411424_14,JSTC_941108322251411424_0,JSTC_1055032000342411424_7,JSTC_885165314491411424_23,JSTC_611780780885388110_0,JSTC_930397056593411424_1,JSTC_620444161089394524_1,JSTC_102252259872271688_4,JSTC_965048288642411424_2,JSTC_1330600213878361843_22,JSTC_185616572035271688_5,JSTC_59896575802271688_3,JSTC_1055032000342411424_29,JSTC_1159903328129405915_0,JSTC_888244675864411424_1,JSTC_2972209687481688_0,JSTC_2972209687261688_1,JSTC_327995168870122389_24,JSTC_102252259362271688_7,JSTC_1159903328091411424_0,JSTC_1630120537146411424_0,JSTC_185616572034271688_2,JSTC_1506353652128411785_23,JSTC_59896575800271688_2,JSTC_1513978201348547021_0,JSTC_185616572035271688_0,JSTC_3200616100401688_11,JSTC_327995168870122389_0,JSTC_625923873023394524_0,JSTC_1159903328122405915_0,JSTC_1157043299930985949_77,JSTC_2972209687261688_5,JSTC_1184133345846088919_67,JSTC_1161332608659405915_0,JSTC_3200616100401688_13,JSTC_59943165609271688_0,JSTC_506083105448475110_3,JSTC_931758082072411424_20,JSTC_327995168870122389_36,JSTC_1159903328127405915_0,JSTC_59943165609271688_2,JSTC_1156231456664985949_72,JSTC_3200616100401688_5,JSTC_129965874639271688_30,JSTC_1159903328118405915_0,JSTC_185616572034271688_3,JSTC_1157043299930985949_75,JSTC_1251440235884694104_0,JSTC_615037025061394524_0,JSTC_129965874639271688_14,JSTC_888302976757411424_2,JSTC_1159903328113405915_0,JSTC_2972209687281688_4,JSTC_517499265006411424_1,JSTC_888302976757411424_3,JSTC_61624452037010266_0,JSTC_512900065927167030_0,JSTC_1630746003100411424_0,JSTC_146543078631556670_2,JSTC_940115362396411424_0";
        String str2 = "JSTC_1251440235884694104_155,JSTC_1251562488701694104_153,JSTC_1251440235884694104_153,JSTC_1251440235884694104_0,JSTC_1251562488701694104_0,JSTC_1513978201348547021_27,JSTC_1515263292745832058_0,JSTC_1513978201348547021_0,JSTC_1506353652128411785_23,JSTC_1506353652128411785_21,JSTC_1506353652128411785_0,JSTC_1352509992084382879_0,JSTC_1330600213878361843_22,JSTC_1329690888772102543_0,JSTC_1184133345846088919_67,JSTC_1185182432375668409_18,JSTC_1157043299930985949_77,JSTC_1157043299930985949_75,JSTC_1156231456664985949_72,JSTC_1157043299930985949_71,JSTC_1099098403344779862_249,JSTC_611780780885388110_16,JSTC_1170182691976388110_15,JSTC_1163613984690076953_39,JSTC_1164452675386076953_47,JSTC_1170182691976388110_0,JSTC_611780780885388110_0,JSTC_1055032000342411424_36,JSTC_1055032000342411424_32,JSTC_1055032000342411424_29,JSTC_1055032000342411424_22,JSTC_1055032000342411424_19,JSTC_1055032000342411424_14,JSTC_1055032000342411424_12,JSTC_1055032000342411424_7,JSTC_1055032000342411424_4,JSTC_965048288642411424_2,JSTC_941108322251411424_0,JSTC_931758082072411424_20,JSTC_931747457904411424_0,JSTC_931758082072411424_0,JSTC_931826115070411424_10,JSTC_931826115070411424_8,JSTC_931826115070411424_6,JSTC_931826115070411424_4,JSTC_931826115070411424_2,JSTC_931576322063411424_0,JSTC_905237538928411424_0,JSTC_572301924472163594_11,JSTC_682441120923495679_2,JSTC_659821568948393686_194,JSTC_615037025061394524_0,JSTC_625923873023394524_0,JSTC_620444161089394524_1,JSTC_620444161089394524_0,JSTC_517499265006411424_1,JSTC_512900065927167030_0,JSTC_506738019565279672_2,JSTC_506117538000638667_4,JSTC_506083105448475110_3,JSTC_505747296537988623_0,JSTC_506083105448475110_0,JSTC_281840614732383794_3,JSTC_327995168870122389_36,JSTC_327995168870122389_24,JSTC_329000194034843071_7,JSTC_327995168870122389_0,JSTC_185616572035271688_18,JSTC_185616572035271688_15,JSTC_185616572035271688_5,JSTC_185616572035271688_0,JSTC_185616572034271688_3,JSTC_185616572034271688_2,JSTC_146543078631556670_2,JSTC_146115267166939567_2,JSTC_155601776674271688_41,JSTC_155601776674271688_40,JSTC_155601776674271688_0,JSTC_152318626207364029_0,JSTC_129916789165271688_104,JSTC_129916789165271688_28,JSTC_129965874639271688_30,JSTC_129965874639271688_14,JSTC_129965874639271688_1,JSTC_104887115489271688_11,JSTC_97409091009271688_6,JSTC_97409091009271688_5,JSTC_102252259872271688_5,JSTC_102252259872271688_4,JSTC_102252259872271688_3,JSTC_96737909760271688_0,JSTC_94724793010271688_3,JSTC_94724793010271688_1,JSTC_73299687440797409_35,JSTC_73299687440797409_32,JSTC_71657583756676773_13,JSTC_61624452037010266_2,JSTC_61485602350271688_10,JSTC_61624452037010266_0,JSTC_61485602350271688_7,JSTC_61485602350271688_3,JSTC_61485602350271688_2,JSTC_61485602350271688_1,JSTC_61485602350271688_0,JSTC_59943165609271688_2,JSTC_59943165609271688_0,JSTC_59955428940271688_2,JSTC_59955428940271688_0,JSTC_3200616100401688_13,JSTC_3200616100401688_11,JSTC_3200616100401688_5,JSTC_3200616100401688_4,JSTC_2972209687261688_6,JSTC_2972209687261688_5,JSTC_2972209687261688_4,JSTC_2972209687261688_3,JSTC_2972209687281688_4,JSTC_2972209687281688_3,JSTC_2972209687261688_1,JSTC_2972209687281688_1,JSTC_1164571842003405915_0,JSTC_1159903328131405915_0,JSTC_1159903328133405915_0,JSTC_1159903328129405915_0,JSTC_1159903328124405915_0,JSTC_1161332608659405915_0,JSTC_1159903328127405915_0,JSTC_1159903328122405915_0,JSTC_1159903328118405915_0,JSTC_1161995138702405915_0,JSTC_1159903328113405915_0,JSTC_1159903328091411424_0,JSTC_1159903328088411424_0,JSTC_940725089949411424_0,JSTC_940848320263411424_2,JSTC_940848320263411424_0,JSTC_940115362396411424_0,JSTC_940248448231411424_0,JSTC_940725089161411424_0,JSTC_935614594771411424_0,JSTC_931856419082411424_0,JSTC_924587523578411424_0,JSTC_930397056593411424_2,JSTC_930397056593411424_1,JSTC_898534304156411424_0,JSTC_897825346378411424_0,JSTC_888244675864411424_1,JSTC_888302976757411424_5,JSTC_888302976757411424_3,JSTC_888302976757411424_2,JSTC_888302976757411424_1,JSTC_885165314491411424_27,JSTC_885165314491411424_26,JSTC_885165314491411424_23,JSTC_885165314491411424_20,JSTC_885165314491411424_19,JSTC_885165314491411424_17,JSTC_885165314491411424_14,JSTC_885165314491411424_13,JSTC_885165314491411424_11,JSTC_102252259362271688_7,JSTC_2972209687481688_0,JSTC_59896575802271688_3,JSTC_59896575802271688_0,JSTC_59896575800271688_2,JSTC_59896575800271688_0,JSTC_76374607080271688_14,JSTC_76374607080271688_12";
        System.out.println(compareStr(str1,str2));
    }
}